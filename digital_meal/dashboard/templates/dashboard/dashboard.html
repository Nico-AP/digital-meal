{% extends "tool/base.html" %}
{% load static django_htmx %}

{% block title %}
  Digital Meal | Admin Dashboard
{% endblock %}

{% block site_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
  <link rel="stylesheet" href="{% static 'reports/css/reports.css' %}">

{% endblock site_css %}


{% block user_nav %}
{% endblock user_nav %}

{% block main_content %}

  <div class="container mt-4">

    <h1 class="mb-4">Admin Dashboard</h1>

    <!-- Classrooms Overview -->
    <div class="row mb-5">
      <div class="col-12">
        <div class="card">

          <div class="card-header">
            <h4 class="mb-0">Classrooms Overview</h4>
          </div>

          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-4">
                <div class="stat-box">
                  <div class="stat-label">Total Classrooms</div>
                  <div class="stat-value">{{ total_classrooms }}</div>
                </div>
              </div>

              <div class="col-md-4">
                <div class="stat-box">
                  <div class="stat-label">Active Classrooms</div>
                  <div class="stat-value text-success">{{ active_classrooms }}</div>
                </div>
              </div>

              <div class="col-md-4">
                <div class="stat-box">
                  <div class="stat-label">Expired Classrooms</div>
                  <div class="stat-value text-muted">{{ expired_classrooms }}</div>
                </div>
              </div>
            </div>

            <h5 class="mt-5">By Module</h5>
            <div>
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th scope="col">Module</th>
                    <th scope="col">Total</th>
                    <th scope="col">Active</th>
                    <th scope="col">Expired</th>
                  </tr>
                </thead>
                <tbody>

                {% for module in classrooms_by_module %}
                  <tr>
                    <td>{{ module.base_module__name }}</td>
                    <td>{{ module.count }}</td>
                    <td>{{ module.n_active }}</td>
                    <td>{{ module.n_expired }}</td>
                  </tr>
                {% empty %}
                  <tr>
                    <td>No Modules Found</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>

            <h5 class="mt-5">Recently Created</h5>
            <div>
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th scope="col">Date</th>
                    <th scope="col">Class ID</th>
                    <th scope="col">Module</th>
                    <th scope="col">Class Name</th>
                    <th scope="col">Teacher</th>
                  </tr>
                </thead>
                <tbody>

                {% for classroom in recent_classrooms %}
                  <tr>
                    <td>{{ classroom.date_created|date:"Y-m-d" }}</td>
                    <td>{{ classroom.url_id }}</td>
                    <td>{{ classroom.base_module.name }}</td>
                    <td>{{ classroom.name }}</td>
                    <td>{{ classroom.owner.email }}</td>
                  </tr>
                {% empty %}
                  <tr>
                    <td>No Classrooms Found</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>

          </div>
          <div class="ps-3 pb-1"><small class="text-muted">Note: Classes created by staff accounts are excluded.</small></div>
        </div>
      </div>
    </div>

    <!-- Teachers Overview -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">Teachers Overview</h4>
          </div>

          <div class="card-body">
            <div class="row mb-3">

              <div class="col-md-6">
                <div class="stat-box">
                  <div class="stat-label">With Classrooms</div>
                  <div class="stat-value text-success">{{ teachers_with_classroom }}</div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="stat-box">
                  <div class="stat-label">Without Classrooms</div>
                  <div class="stat-value text-muted">{{ teachers_without_classroom }}</div>
                </div>
              </div>

            </div>

            <h5 class="mt-5">Recently Registered</h5>
            <div>
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th scope="col">Date</th>
                    <th scope="col">E-Mail</th>
                    <th scope="col">Canton</th>
                  </tr>
                </thead>
                <tbody>

                {% for teacher in recent_teachers %}
                  <tr>
                    <td>{{ teacher.date_joined|date:"Y-m-d" }}</td>
                    <td>{{ teacher.email }}</td>
                    <td>{{ teacher.teacher.canton }}</td>
                  </tr>
                {% empty %}
                  <tr>
                    <td>No Classrooms Found</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>

            <h5 class="mt-5">Top Cantons</h5>
            <div>
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Count</th>
                  </tr>
                </thead>
                <tbody>

                {% for canton in teachers_by_canton %}
                  <tr>
                    <td>{{ canton.canton }}</td>
                    <td>{{ canton.count }}</td>
                  </tr>
                {% empty %}
                  <tr>
                    <td>No data available</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            </div>

          </div>
          <div class="ps-3 pb-1"><small class="text-muted">Note: Staff accounts are excluded.</small></div>
        </div>

      </div>
    </div>

    <!-- Participants Overview (loaded via HTMX) -->
    <div class="row mb-5">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h4 class="mb-0">Participation Overview</h4>
          </div>
          <div class="card-body">
            <div id="participant-stats"
                 hx-get="{% url 'dashboard_participant_stats' %}"
                 hx-trigger="load"
                 hx-swap="innerHTML">
              <div class="text-center py-4">
                <div class="row justify-content-center">
                  <div class="col-auto">{% include "reports/components/loader.html" %}</div>
                </div>
                <p class="mt-2 text-muted">Loading participant statistics...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

{% endblock main_content %}

{% block footer_content %}
{% endblock footer_content %}

{% block site_js %}
  {{ block.super }}
  {% htmx_script %}
{% endblock %}
